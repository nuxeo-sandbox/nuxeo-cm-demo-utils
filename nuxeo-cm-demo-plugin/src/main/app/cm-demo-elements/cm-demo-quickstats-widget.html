<!--
@license
(C) Copyright 2015 Nuxeo SA (http://nuxeo.com/) and others.

Licensed under the Apache License, Version 2.0 (the "License"); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
  Joshua Fletcher <jfletcher@nuxeo.com>
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../nuxeo-elements/nuxeo-connection.html">
<link rel="import" href="../nuxeo-elements/nuxeo-page-provider.html">

<!--
An element for displaying the progress of claims in the CM demo.

Example:

    <cm-demo-quickstats-widget>
    </cm-demo-quickstats-widget>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--cm-demo-quickstats-widget` | Mixin applied to the element | `{}`

@group Nuxeo CM Demo Elements
@element cm-demo-quickstats-widget
@demo demo/demo-cm-demo-quickstats-widget.html
-->
<dom-module id="cm-demo-quickstats-widget">

  <template>

    <style>
      :host {
        @apply(--cm-demo-quickstats-widget);
      }

      paper-card {
        --paper-card-header-color: #ffffff;
        --paper-card-header: {
          background: #236ba5;
        }
      }

      .claim-total {
        text-align: center;
      }

      .claim-state {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
      }

      .progress-bar {
        display: table;
      }

      .count {
        padding-left: 5px;
        font-size: smaller;
        display: table-cell;
        vertical-align: middle;
      }

      paper-progress.single {
        --paper-progress-height: 20px;
        display: table-cell;
        vertical-align: middle;
      }

      .progress-on-schedule {
        --paper-progress-active-color: #00a300;
      }

      .progress-past-due {
        --paper-progress-active-color: #cc0000;
      }

      .progress-done {
        --paper-progress-active-color: #00bcad;
      }

      .bar-hidden {
        width: 0;
      }

      .bar-past-due {
        width: 0;
      }

      .bar-done {
        width: 0;
      }

      .histogram {
        display: inline-flex;
      }

      .countSingle {
        color: #545454;
        font-size: x-small;
      }

    </style>

    <nuxeo-connection></nuxeo-connection>
    <!-- Get claims on schedule claims. -->
    <nuxeo-page-provider auto query="[[_queryOnScheduleClaims]]" page-size="1" results-count="{{countClaimsOnSchedule}}"></nuxeo-page-provider>
    <nuxeo-page-provider auto query="[[_queryPastDueClaims]]" page-size="1" results-count="{{countClaimsPastDue}}"></nuxeo-page-provider>

    <!-- Get completed claims. -->
    <nuxeo-page-provider auto query="[[_queryDoneClaims]]" page-size="1" results-count="{{claimsDone}}"></nuxeo-page-provider>

    <paper-card heading="Claims Progress" class="justified">

      <div class="card-content">
        <div class="claim-state">
          <div>On Schedule <span class="countSingle">[[countClaimsOnSchedule]] Claims</span></div>
          <div class="progress-bar">
            <paper-progress value="[[percentClaimsOnSchedule]]" class="progress-on-schedule single"></paper-progress>
            <div class="count ">[[percentClaimsOnSchedule]]%</div>
          </div>
        </div>
        <div class="claim-state">
          <div>Past Due <span class="countSingle">[[countClaimsPastDue]] Claims</span></div>
          <div class="progress-bar">
            <paper-progress value="[[percentClaimsPastDue]]" class="progress-past-due single"></paper-progress>
            <div class="count ">[[percentClaimsPastDue]]%</div>
          </div>
        </div>

        <template is="dom-if" if="[[!claimState]]">
          <div class="claim-state">
            <div>Done <span class="countSingle">[[claimsDone]] Claims</span></div>
            <div class="progress-bar">
              <paper-progress value="[[claimsDone]]" class="progress-done single"></paper-progress>
              <div class="count ">50%</div>
            </div>
          </div>
        </template>

        <div>Total Claims: [[_totalInProgressClaims]]</div>
        <div class="histogram">
          <paper-progress value="100" class="progress-on-schedule bar-hidden" style="width: [[_convertPercentToProgressWidth(percentClaimsOnSchedule)]];"></paper-progress>
          <paper-progress value="100" class="progress-past-due bar-hidden" style="width: [[_convertPercentToProgressWidth(percentClaimsPastDue)]];"></paper-progress>
          <template is="dom-if" if="[[!claimState]]">
            <paper-progress value="100" class="progress-done bar-done"></paper-progress>
          </template>
        </div>
      </div>

    </paper-card>

  </template>

  <script>
    Polymer({
      is: 'cm-demo-quickstats-widget',

      properties: {
        claimKind: {
          type: String
        },
        claimState: {
          type: String
        },
        _queryOnScheduleClaims: {
          type: String
        },
        _queryPastDueClaims: {
          type: String
        },
        _queryDoneClaims: {
          type: String
        },
        percentClaimsOnSchedule: {
          type: Number,
          computed: '_computePercent(countClaimsOnSchedule,_totalInProgressClaims)'
        },
        percentClaimsPastDue: {
          type: Number,
          computed: '_computePercent(countClaimsPastDue,_totalInProgressClaims)'
        },
        _totalInProgressClaims: {
          type: Number,
          computed: '_computeTotalInProgressClaims(countClaimsOnSchedule, countClaimsPastDue)'
        }
      },

      observers: [
        '_set_queryOnScheduleClaims(claimKind)',
        '_set_queryOnScheduleClaims(claimState)',
        '_set_queryPastDueClaims(claimKind)',
        '_set_queryPastDueClaims(claimState)',
        '_set_queryDoneClaims(claimKind)',
        '_set_queryDoneClaims(claimState)'
      ],

      _queryGenericFilter: function() {
        var genericFilter = "";
        genericFilter = genericFilter + "SELECT * FROM Document";
        genericFilter = genericFilter + " WHERE ecm:mixinType != 'HiddenInNavigation'";
        genericFilter = genericFilter + " AND ecm:isCheckedInVersion = 0";
        genericFilter = genericFilter + " AND ecm:currentLifeCycleState != 'deleted'";
        genericFilter = genericFilter + " AND ecm:primaryType = 'InsuranceClaim'";
        return genericFilter;
      },

      // Generate today's date in YYYY-MM-DD for NXQL.
      _queryTodayFilter: function(operator) {
        var todayDate = new Date();
        var todayString = todayDate.getFullYear() + "-" + (todayDate.getMonth() + 1) + "-" + todayDate.getDate();
        var todayFilter = " AND incl:due_date " + operator + " DATE '" + todayString + "'";
        return todayFilter;
      },

      _queryInProgressFilter: function(operator) {
        var inProgressFilter = this._queryGenericFilter();

        if (this.claimState) {
          inProgressFilter = inProgressFilter + " AND ecm:currentLifeCycleState = '" + this.claimState + "'";
        } else {
          // If no state is specified, I must filter compeleted claims at least. A completed claim cannot be "in progress".
          inProgressFilter = inProgressFilter + " AND ecm:currentLifeCycleState NOT IN ('Archived','DecisionMade')";
        }

        if (this.claimKind) {
          inProgressFilter = inProgressFilter + " AND incl:incident_kind = '" + this.claimKind + "'";
        }
        inProgressFilter = inProgressFilter + this._queryTodayFilter(operator);

        return inProgressFilter;
      },

      _set_queryOnScheduleClaims: function() {
        this._queryOnScheduleClaims = this._queryInProgressFilter(">=");
      },

      _set_queryPastDueClaims: function() {
        this._queryPastDueClaims = this._queryInProgressFilter("<");
      },

      _set_queryDoneClaims: function() {
        this._queryDoneClaims = this._queryGenericFilter() + " AND ecm:currentLifeCycleState = 'DecisionMade'"
      },

      _computeTotalInProgressClaims: function(countClaimsOnSchedule, countClaimsPastDue) {
        return countClaimsOnSchedule + countClaimsPastDue;
      },

      _computePercent: function(numerator, denominator) {
        return Math.round((numerator / denominator * 100));
      },

      _convertPercentToProgressWidth: function(percentage){
        return percentage * 2;
      },

      _debug: function(data) {
        debugger;
      }
    });

  </script>

</dom-module>
